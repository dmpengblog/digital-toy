C51 COMPILER V8.01   MAIN                                                                  06/07/2010 22:51:14 PAGE 1   


C51 COMPILER V8.01, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c ROM(COMPACT) WARNINGLEVEL(1) OPTIMIZE(5,SIZE) INCDIR(.;.\driver)

line level    source

   1          #include "config.h"
   2          #include <adc.h>
   3          #include <pwm.h>
   4          
   5          #include <adc0832.h>
   6          
   7          #include <charger.h>
   8          
   9          #include <1602.h>
  10          
  11          
  12          
  13          extern float  refV ; 
  14          char t=0;
  15          unsigned short i=0;
  16          
  17          //easy charging
  18          unsigned char duty=0, max_duty=15;
  19          float current=0, voltage=0;
  20          float vlimit = 7.0 ; //V
  21          float climit = 1.1 ; //A
  22          float ir = 0 ;  //battery internal resistor
  23          void easy_charging();
  24          
  25          char charging = 0;  //not incharging
  26          void isdone();
  27          
  28          //i_charger charger = INIT_CHARGER;
  29          
  30          
  31          void io_init()
  32          {
  33   1         pwm_init(); //pull down pwm
  34   1         lcd1602_init();
  35   1          lcd_cursor(0,0);
  36   1         lcd_puts("Welcom!");
  37   1         seg_init();
  38   1         mdelay(100);
  39   1       
  40   1      }
  41          void main()
  42          {
  43   1         unsigned short n,x=0;
  44   1         unsigned short onduty=0;
  45   1         float adc;
  46   1      
  47   1      
  48   1         io_init();
  49   1                 
  50   1         timer0_init(); //pwm
  51   1        // timer1_init();
  52   1      
  53   1         //adc_init(); 
  54   1         irqon();   //enable global interrupt         
  55   1         sleep(0); // just refrence 
C51 COMPILER V8.01   MAIN                                                                  06/07/2010 22:51:14 PAGE 2   

  56   1         while(1){
  57   2         
  58   2      // KEY_FUNC P3_3  KEY_DISCHARGER  P3_2  KEY_RESUME    P3_1  
  59   2          
  60   2           if(key(KEY_OK))
  61   2                  ;
  62   2      
  63   2               if(key(KEY_DIS)) i++;
  64   2                 
  65   2          
  66   2               if(key(KEY_RES)) i--;
  67   2      
  68   2         
  69   2                voltage=adc_V();
  70   2            lcd_cursor(0,0);
  71   2            lcd_puts("V: ");
  72   2                showVA(voltage*100);
  73   2      
  74   2                current=adc_A();
  75   2                lcd_cursor(0,1);
  76   2            lcd_puts("A: ");
  77   2                showVA(current*100);
  78   2                
  79   2                lcd_puts(" pwm:");
  80   2                print10(duty);
  81   2      
  82   2              /*charging core*/
  83   2               isdone();
  84   2                easy_charging();
  85   2               
  86   2         /*end charging*/     
  87   2                
  88   2         }
  89   1        
  90   1        
  91   1      }
  92          
  93          adj_c()
  94          {
  95   1      
  96   1        char  i=0;
  97   1      
  98   1         for( i=1;i<max_duty;i++){
  99   2           current=adc_A();    
 100   2           if(current < climit){
 101   3              duty+=1;
 102   3                 if(duty>max_duty)
 103   3                     duty=max_duty;
 104   3      
 105   3           }
 106   2           
 107   2           if(current > climit){
 108   3              if(duty>0)
 109   3                       duty-=1;
 110   3                  if(duty==0)
 111   3                     duty==1;
*** WARNING C275 IN LINE 111 OF MAIN.C: expression with possibly no effect
 112   3          }
 113   2      
 114   2               pwm_setduty(duty);
 115   2               current=adc_A();
 116   2               voltage=adc_V();
C51 COMPILER V8.01   MAIN                                                                  06/07/2010 22:51:14 PAGE 3   

 117   2                        voltage=adc_V();
 118   2            lcd_cursor(0,0);
 119   2            lcd_puts("V: ");
 120   2                showVA(voltage*100);
 121   2      
 122   2                current=adc_A();
 123   2                lcd_cursor(0,1);
 124   2            lcd_puts("A: ");
 125   2                showVA(current*100);
 126   2         }  
 127   1      
 128   1      }
 129          void isdone()
 130          {
 131   1          float bv=0;
 132   1        
 133   1         if(voltage < 0.5 || voltage>8.0) /*no battery or pull out*/
 134   1            charging = 0;
 135   1      
 136   1          if(1==charging) return; /*in charging*/
 137   1      
 138   1          /*try new charging */
 139   1          /*para*/
 140   1              vlimit = 7.0; /*test battry*/
 141   1      
 142   1          /*test battery*/
 143   1           pwm_setduty(0);
 144   1               mdelay(100);
 145   1           bv=voltage=adc_V();        
 146   1           if(voltage> 3)
 147   1                  charging = 1;
 148   1      
 149   1               if(0==charging) /*no battery*/
 150   1                  return;
 151   1      
 152   1              /*test internal resistor*/
 153   1          pwm_setduty(5);
 154   1              mdelay(100);
 155   1              mdelay(100);
 156   1                current=adc_A();
 157   1                voltage=adc_V();
 158   1                        voltage=adc_V();
 159   1            lcd_cursor(0,0);
 160   1            lcd_puts("V: ");
 161   1                showVA(voltage*100);
 162   1      
 163   1                current=adc_A();
 164   1                lcd_cursor(0,1);
 165   1            lcd_puts("A: ");
 166   1                showVA(current*100);
 167   1      
 168   1              pwm_setduty(0);
 169   1              ir = (voltage-bv)/current;
 170   1          
 171   1              lcd_cursor(9,0);
 172   1          lcd_puts("ir:");
 173   1              print10(1000*ir);
 174   1      
 175   1              if(ir>1.5) {
 176   2                 lcd_cursor(9,0) ;
 177   2                 mdelay(100); mdelay(100);    mdelay(100);
 178   2             mdelay(100);     mdelay(100);
C51 COMPILER V8.01   MAIN                                                                  06/07/2010 22:51:14 PAGE 4   

 179   2             lcd_puts("bad ir  ");
 180   2              }
 181   1                 
 182   1              /*set parameter */
 183   1               vlimit = 6.9;
 184   1               climit = 1.2;
 185   1      
 186   1           /*init start*/
 187   1           pwm_setduty(1);
 188   1               mdelay(100);mdelay(100);
 189   1               mdelay(100);mdelay(100);
 190   1               current=adc_A();
 191   1               voltage=adc_V();
 192   1               duty=1;
 193   1                  /*adjust the current*/
 194   1      
 195   1               adj_c();
 196   1      
 197   1      }
 198          
 199          void easy_charging()
 200          {
 201   1         if(!charging) return;
 202   1      
 203   1         if(duty==0) goto done; /*already complete charging*/
 204   1        
 205   1      
 206   1      
 207   1         
 208   1      
 209   1         /*ending test*/
 210   1         if(current <0.100) /*drop to 50mA, so done*/
 211   1             goto done;
 212   1      
 213   1         if( voltage > (vlimit+ir*current)){
 214   2                 if(duty>0)
 215   2                      duty-=1;
 216   2                 if(duty==0)
 217   2                    goto done;
 218   2         
 219   2         }
 220   1          
 221   1         pwm_setduty(duty);     
 222   1              
 223   1            
 224   1      
 225   1         return;
 226   1      /* complete the charging */
 227   1         done:
 228   1         {
 229   2            duty=0;
 230   2            pwm_setduty(duty);
 231   2      
 232   2                bl_off();
 233   2            mdelay(55);
 234   2                bl_on();
 235   2                mdelay(55);
 236   2                bl_off();
 237   2            mdelay(55);
 238   2                bl_on();
 239   2                mdelay(55);
 240   2                bl_off();
C51 COMPILER V8.01   MAIN                                                                  06/07/2010 22:51:14 PAGE 5   

 241   2            mdelay(55);
 242   2                bl_on();
 243   2                mdelay(55);
 244   2                
 245   2         }
 246   1      
 247   1      
 248   1      }
 249          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1097    ----
   CONSTANT SIZE    =     35    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     26      15
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
