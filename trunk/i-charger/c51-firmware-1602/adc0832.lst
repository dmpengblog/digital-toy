C51 COMPILER V8.01   ADC0832                                                               12/13/2009 18:48:29 PAGE 1   


C51 COMPILER V8.01, COMPILATION OF MODULE ADC0832
OBJECT MODULE PLACED IN adc0832.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE driver\adc0832.c ROM(COMPACT) WARNINGLEVEL(1) OPTIMIZE(5,SIZE) INCDIR(.\dri
                    -ver) PRINT(.\adc0832.lst) OBJECT(adc0832.obj)

line level    source

   1          #include <config.h>
   2          
   3          #include "adc0832.h"
   4          
   5          
   6          
   7          #define CS       P3_0
   8          #define CLK      P3_1
   9          
  10          #define DI   P3_2
  11          #define DO   P3_3
  12          
  13          unsigned char adc0832(bit ch)
  14          {
  15   1      
  16   1         unsigned char i, dat0=0, dat1=0;
  17   1      
  18   1         
  19   1         CLK = 0;   //init clk
  20   1         
  21   1         DO = 1;    //prepare start bit
  22   1         CS=0;          //enable 
  23   1         udelay(0); //delay tsu
  24   1         CLK = 1;   //up edge, send start bit
  25   1         udelay(0);
  26   1      
  27   1         
  28   1         CLK = 0;   //prepare send SGL/DIF
  29   1         udelay(0);
  30   1         DO = 1;    //SGL/DIF = 1, channel mode
  31   1         CLK =1;    // up edge, send SGL/DIF
  32   1         udelay(0);
  33   1      
  34   1         
  35   1         CLK=0;    // prepare send ODD/EVEN, ch
  36   1         udelay(0);
  37   1         DO = ch;       //send channel, 0,or 1
  38   1         CLK=1;     //up ledge;
  39   1         udelay(0);
  40   1      
  41   1         
  42   1         CLK=0;  // 
  43   1         DI=1;   //prepare input
  44   1         udelay(0); //delay tsu
  45   1         for(i=0;i<8;i++){
  46   2           CLK =1;
  47   2           udelay(0);         //没有这些delay则LSB,MSB方式读取的值会不等, 太快了
  48   2               CLK =0;  //donw edge /MSB first
  49   2           udelay(0);
  50   2               if(DI)
  51   2                      dat0 |= 0x80>>i;   
  52   2         }
  53   1      
  54   1         for(i=0;i<8;i++){ //LSB first
C51 COMPILER V8.01   ADC0832                                                               12/13/2009 18:48:29 PAGE 2   

  55   2           udelay(0);
  56   2           if(DI)
  57   2                      dat1 |= 0x01<<i;   
  58   2                CLK =1;
  59   2            udelay(0);
  60   2                CLK =0;  //donw edge
  61   2               
  62   2         }
  63   1         CS=1;  //deselect chip
  64   1         DI=1;
  65   1         CLK=1;
  66   1      
  67   1         if(dat0==dat1) {
  68   2              //      vledmod('V'); 
  69   2              return dat1;
  70   2      
  71   2              }
  72   1         //vledmod('H'); 
  73   1        
  74   1         return dat0;
  75   1      
  76   1      }
  77          
  78          
  79          
  80          float  refV = 4.10 ; 
  81          
  82          float adc_V()
  83          {
  84   1           unsigned short adc_v;
  85   1                          
  86   1           adc_v = adc0832(1);  
  87   1               mdelay(10);
  88   1               adc_v += adc0832(1);  
  89   1      
  90   1               adc_v /=2;
  91   1               
  92   1               return (((float)adc_v)/255)*refV*1.9; //10mV
  93   1      }
  94          
  95          
  96          
  97          float adc_A()
  98          {
  99   1              unsigned char adc_i;
 100   1              float tmp=0.0;
 101   1          /*sample the charger current*/
 102   1              adc_i = adc0832(0);
 103   1              mdelay(10);
 104   1              adc_i += adc0832(0);
 105   1              adc_i /=2;
 106   1              
 107   1              tmp= ((float)adc_i/255)*refV;
 108   1              tmp = tmp/20;
 109   1              return tmp = tmp/0.10;
 110   1              
 111   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    361    ----
   CONSTANT SIZE    =   ----    ----
C51 COMPILER V8.01   ADC0832                                                               12/13/2009 18:48:29 PAGE 3   

   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      4      10
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
