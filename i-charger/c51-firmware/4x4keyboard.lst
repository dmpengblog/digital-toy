C51 COMPILER V8.01   4X4KEYBOARD                                                           10/28/2009 22:03:40 PAGE 1   


C51 COMPILER V8.01, COMPILATION OF MODULE 4X4KEYBOARD
OBJECT MODULE PLACED IN 4x4keyboard.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE driver\4x4keyboard.c ROM(COMPACT) BROWSE INCDIR(.\driver) DEBUG OBJECTEXTEN
                    -D PRINT(.\4x4keyboard.lst) OBJECT(4x4keyboard.obj)

line level    source

   1          
   2          #include <config.h>
   3                             
   4          
   5          // S52 P1  has internal pullup resistor
   6          // h1,h2--> p1_0, p1_1
   7          unsigned char keyscan(void)
   8          
   9          {
  10   1      
  11   1        unsigned char scan;
  12   1        unsigned char col;
  13   1        char row;
  14   1      
  15   1      /*
  16   1        电路
  17   1        p1_0     -- R ---     +          +
  18   1        p1_1     --R---       +          +
  19   1        p1_2    -----------      +
  20   1        p1_3 行2-----------------
  21   1      */
  22   1      
  23   1       /*  
  24   1                  col: 7  6  5  4
  25   1        row1-> bit3    k  k  k  k
  26   1        row1-> bit2    k  k  k  k
  27   1                           k  k  k  k
  28   1                           k  k  k  k
  29   1      
  30   1       */
  31   1        for(row=3; row>=0; row--)             
  32   1        {
  33   2          //扫描一行
  34   2      
  35   2          P1=0xff; 
  36   2          udelay(2);
  37   2           
  38   2          P1=0xFF & (~( 1<< row)); //拉低一行 , 11110111
  39   2      
  40   2          udelay(2);
  41   2          scan=P1;
  42   2          udelay(256); //延时防抖
  43   2      
  44   2          if(scan!=P1) //可能是抖动
  45   2            continue;
  46   2      
  47   2              
  48   2          scan&= 0xF0;
  49   2              scan >>=4; 
  50   2              
  51   2              if(scan == 0xF0) //no key press down
  52   2                 continue;
  53   2      
  54   2          for(col=0;col<4;col++){
C51 COMPILER V8.01   4X4KEYBOARD                                                           10/28/2009 22:03:40 PAGE 2   

  55   3                  if(! ( scan&(1<<(3-col))) ){
  56   4                wait_release: 
  57   4                            scan = P1; 
  58   4                                if ((scan&0xF0) != 0xF0  )
  59   4                                  goto  wait_release;
  60   4      
  61   4                 return (3-row)*4+col;
  62   4      
  63   4                      }
  64   3            }
  65   2        }
  66   1      
  67   1        return -1;
  68   1      
  69   1      
  70   1      }
  71          
  72          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    132    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       2
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
