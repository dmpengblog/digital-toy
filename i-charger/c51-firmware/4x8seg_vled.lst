C51 COMPILER V8.01   4X8SEG_VLED                                                           10/29/2009 19:45:54 PAGE 1   


C51 COMPILER V8.01, COMPILATION OF MODULE 4X8SEG_VLED
OBJECT MODULE PLACED IN 4x8seg_vled.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE driver\4x8seg_vled.c ROM(COMPACT) BROWSE INCDIR(.\driver) DEBUG OBJECTEXTEN
                    -D PRINT(.\4x8seg_vled.lst) OBJECT(4x8seg_vled.obj)

line level    source

   1          
   2          #include <config.h>
   3          
   4          #include <4x8seg_vled.h>
   5          #include <string.h>
   6          
   7          #define segENA1  P2_0
   8          #define segENA2  P2_1
   9          #define segENA3  P2_2
  10          #define segENA4  P2_3
  11          #define vledENA  P2_4
  12          #define segData  P0
  13          
  14          #define vledon()   segoff(0xF); vledENA=0;
  15          #define vledoff()  vledENA=1;
  16          
  17          
  18          
  19          #define segDOT  0X7F  /*dot*/
  20          
  21          
  22          
  23          #define segH   0X76,/*H*/
  24          #define segh   0X74,/*h*/
  25          #define segL   0X38,/*L*/
  26          #define segP   0X73,/*P*/
  27          #define segt   0X78,/*t*/
  28          #define seg-   0X40,/*-*/
  29          
  30          #if 0  /*节省变量空间, ft*/
              unsigned char seg0_f[]={
                      0XC0,/*0*/
                      0XF9,/*1*/
                      0XA4,/*2*/
                      0XB0,/*3*/
                      0X99,/*4*/
                      0X92,/*5*/
                      0X82,/*6*/
                      0XF8,/*7*/
                      0X80,/*8*/
                      0X90,/*9*/
                    
                      0X88,/*A*/
                      0X83,/*b*/
                      0XC6,/*C*/
                      0XA1,/*d*/
                      0X86,/*E*/
                      0X8E,/*F*/
              
              #if 0
                      0X3F,/*0*/
                      0X06,/*1*/
                      0X5B,/*2*/
                      0X4F,/*3*/
C51 COMPILER V8.01   4X8SEG_VLED                                                           10/29/2009 19:45:54 PAGE 2   

                      0X66,/*4*/
                      0X6D,/*5*/
                      0X7D,/*6*/
                      0X07,/*7*/
                      0X7F,/*8*/
                      0X6F,/*9*/
              #endif
              
              };
              
              #endif
  66          
  67          unsigned seg0_f(char c)
  68          {
  69   1         switch(c){
  70   2            case 0:
  71   2                    return  0XC0;
  72   2                case 1:
  73   2                    return  0XF9;
  74   2                case 2:
  75   2                    return  0XA4;
  76   2                case 3:
  77   2                    return  0XB0;
  78   2            case 4:
  79   2                    return  0X99;
  80   2            case 5:
  81   2                    return  0X92;
  82   2            case 6:
  83   2                    return  0X82;
  84   2            case 7:
  85   2                    return  0XF8;
  86   2            case 8:
  87   2                    return  0X80;
  88   2            case 9:
  89   2                    return  0X90;
  90   2            case 0xa:
  91   2                    return  0X88;
  92   2            case 0xb:
  93   2                    return  0X83;
  94   2            case 0xc:
  95   2                    return  0XC6;
  96   2            case 0xd:
  97   2                    return  0XA1;
  98   2            case 0xe:
  99   2                    return  0X86;
 100   2            case 0xf:
 101   2                    return  0X8e;
 102   2            default:
 103   2                    return  0XFF;
 104   2         }
 105   1      }
 106          void segoff( unsigned char segbit)
 107          {
 108   1         if(segbit&0x1)
 109   1              segENA1=1;
 110   1         if(segbit&0x2)
 111   1              segENA2=1;
 112   1         if(segbit&0x4)
 113   1             segENA3=1;
 114   1         if(segbit&0x8)
 115   1             segENA4=1;
 116   1      /*
C51 COMPILER V8.01   4X8SEG_VLED                                                           10/29/2009 19:45:54 PAGE 3   

 117   1         switch bit {
 118   1           case 1:
 119   1              segENA1=1;
 120   1           case 2:
 121   1              segENA2=1;
 122   1           case 3:
 123   1              segENA3=1;
 124   1           case 4:
 125   1              segENA4=1;
 126   1           
 127   1         }
 128   1         */
 129   1      }
 130          
 131          void segon(unsigned char segbit) 
 132          {
 133   1         if(segbit&0x1)
 134   1              segENA1=0;
 135   1         if(segbit&0x2)
 136   1              segENA2=0;
 137   1         if(segbit&0x4)
 138   1             segENA3=0;
 139   1         if(segbit&0x8)
 140   1             segENA4=0;
 141   1         
 142   1      }
 143          
 144          
 145          #if 0
              void segchar(unsigned char c, unsigned char segbit)
              {
                 segoff(0xF);
                 segData = c;      
                 switch ( segbit ){
                   case 0:
                      segENA1=0;
                              break;
                   case 1:
                      segENA2=0;
                              break;
                   case 2:
                      segENA3=0;
                              break;
                   case 3:
                          segENA4=0;
                              break;
                       default:
                          ;
                   
                 }
              }
              #endif
 169          void testseg()
 170          {
 171   1         unsigned char n;
 172   1         segon(0xF);
 173   1                
 174   1         for(n=0;n<=9;n++){
 175   2                 segData = seg0_f(n);
 176   2                mdelay(64);
 177   2         
 178   2         }
C51 COMPILER V8.01   4X8SEG_VLED                                                           10/29/2009 19:45:54 PAGE 4   

 179   1         
 180   1         for(n=0;n<=9;n++){
 181   2                 segData = seg0_f(n) & segDOT;
 182   2                mdelay(64);
 183   2         }
 184   1      
 185   1      }
 186          
 187          
 188          void testvled()
 189          {
 190   1        unsigned char n;
 191   1        vledon();
 192   1        
 193   1        segData = 0xff;
 194   1        segData = 0;
 195   1        mdelay(255);
 196   1        segData = 0xff;
 197   1        mdelay(255);
 198   1         
 199   1        for(n=0;n<=8;n++){
 200   2                segData = ~(1<<n);
 201   2                mdelay(64);
 202   2        }
 203   1      
 204   1        vledoff();
 205   1      }
 206          
 207          /*===========================================================================*/
 208          /*
 209           * 数码管扫描显示 core
 210           */
 211          
 212          void segvled_init()
 213          {
 214   1         //power on test
 215   1         segoff(0xF);
 216   1         testseg();
 217   1         testvled();
 218   1        
 219   1         //close all
 220   1         segoff(0xF);
 221   1         vledoff();
 222   1      }
 223          
 224          
 225          
 226          /*
 227           *
 228           *  vblock[0] .... vblock[3]    vled
 229           *
 230           */
 231          //unsigned vblock[5]={0xFF,0xFF,0xFF,0xFF,0xFF};
 232          
 233          unsigned char vblock[5]={
 234                         0XC0,/*0*/
 235                         0XF9,/*1*/
 236                         0XA4,/*2*/
 237                         0XB0,/*3*/
 238                                     ~(0xf)};
 239          static unsigned char dot = 0,lastdot=0;
 240          
C51 COMPILER V8.01   4X8SEG_VLED                                                           10/29/2009 19:45:54 PAGE 5   

 241          /*
 242           * 根据 vblock内容 扫描驱动数码管和电平管显示
 243           */
 244          void ms_scan_segvled() using 1 
 245          {
 246   1               static unsigned char block = 0;
 247   1               
 248   1               vblock[lastdot] |= ~segDOT; //set dot bit, clear the dot
 249   1               if(dot<4){
 250   2                      vblock[dot] &=segDOT;  //clear bit  
 251   2               }
 252   1      
 253   1               if(block<4){ //scan 4x8 seg
 254   2                  vledoff(); 
 255   2                      segoff(0xF);
 256   2                      segData = vblock[block];             
 257   2                      
 258   2                  segon(1<<block);    
 259   2      
 260   2               }else { //scan vled
 261   2                     segoff(0xF);
 262   2                         segData = vblock[4];
 263   2                         vledon();
 264   2                         
 265   2                 
 266   2               } 
 267   1               block++;
 268   1               if(5 == block)
 269   1                 block = 0;
 270   1      
 271   1      }
 272          
 273          
 274          
 275          enum VLED_MODE   vled_mode= VLED_V;
 276          
 277          void vledmod(enum VLED_MODE mod)
 278          {
 279   1           vled_mode = mod;  
 280   1      }
 281          /*
 282           *  更新显示内容, 实现vled mode
 283           *        : 电流,电压,HZ, 错误
 284           */
 285          void update_vled()
 286          {                    
 287   1       #define VLED_R  vblock[4]
 288   1           static unsigned long lasttime=0,pos=0;
 289   1              
 290   1               if(vled_mode < VLED_STOP)
 291   1                    VLED_R = ~(1<<vled_mode);
 292   1      
 293   1               if(vled_mode == VLED_STOP)
 294   1                     return;  
 295   1                      
 296   1               if(timeafter(jiffers,lasttime+(HZ)/10)){
 297   2                  // 10 times/per second
 298   2                       if(vled_mode  == VLED_A){ //A mA
 299   3                          vblock[4] = 0xF;            
 300   3                  vblock[4]= rol8(vblock[4], 1);
 301   3                       }
 302   2                
C51 COMPILER V8.01   4X8SEG_VLED                                                           10/29/2009 19:45:54 PAGE 6   

 303   2                      if(vled_mode == VLED_V){ //V mV
 304   3                              if(pos&0x4 ){     // pos&0x100 == 0x100 doesn't work!!!!!!!!
 305   4                                   vblock[4] = 0x5A;
 306   4                           }else{
 307   4                                   vblock[4] = 0xA5;
 308   4                           }
 309   3                      
 310   3                      }
 311   2      
 312   2                      if(vled_mode == VLED_HZ){ //Hz
 313   3                               if(pos&0x2 ){
 314   4                       vblock[4] = 0x5A;
 315   4                               }else{
 316   4                                   vblock[4] = 0xFF;
 317   4                           }
 318   3                      }     
 319   2      
 320   2               if(vled_mode == VLED_ERR) { //Err
 321   3                               if(pos&0x1 ){
 322   4                                   vblock[4] = 0xFF;
 323   4                       vblock[0]=vblock[1]=vblock[2]=vblock[3]=segDOT;
 324   4                           }else{
 325   4                                   vblock[4] = 0xFF;
 326   4                       vblock[0]=vblock[1]=vblock[2]=vblock[3]=0xFF;
 327   4                                   
 328   4                                       
 329   4                           }            
 330   3                       }     
 331   2                      
 332   2                       if(vled_mode == VLED_DETECT){
 333   3                               if(pos&0x1 )
 334   3                                  vblock[4]=0xFF;
 335   3                            else
 336   3                                  vblock[4]=0x0;
 337   3                       } 
 338   2                       pos++; 
 339   2                       lasttime = jiffers;
 340   2              
 341   2               }
 342   1              
 343   1                      
 344   1              
 345   1               
 346   1      }
 347          
 348          #if 0
              
              /*
               *  循环 4种提示模式, 演示用
               */
              void segvled_demo()
              {
              
                      static unsigned long mode_show_time=0;
              
                      if(timeafter(jiffers,mode_show_time+4*5000)){ //3s
                                      
              
                                        if(vled_mode == 3){ //从3模式, err退出,随机重置所有数码管
                                           vblock[4]= 0xFF;
              
                                               vblock[1]= seg0_f((jiffers)>>5&0xf);
C51 COMPILER V8.01   4X8SEG_VLED                                                           10/29/2009 19:45:54 PAGE 7   

                                               vblock[2]= seg0_f((jiffers)>>7&0xf);
                                               vblock[3]= seg0_f(jiffers&0xf);
                                               
                                               vblock[0]= segDOT;
                                        } 
                                              
                                        
                                        vled_mode++;
                                        vled_mode&=0x3;
                            
                                        if(vled_mode == 0 )
                                       vledmod('A');                   
                                        
                                        mode_show_time = jiffers;
                                        
                              }
              }
              
              void printhex(unsigned short n)
              {
                   //irqoff();
                       vblock[0]= seg0_f( (n/1000) );
                       n = n%1000;
                       vblock[1]= seg0_f( n/100 );
                       n = n%100;
                                      
                       vblock[2]= seg0_f((n/10));
                       vblock[3]= seg0_f((n%10));
                       //irqon();
              }
              #endif
 396          
 397          /*
 398           * set dot position
 399           */                
 400          void setdot(unsigned char n)
 401          {
 402   1         dot=n;
 403   1      
 404   1      }
 405          void print10(unsigned short n)
 406          {
 407   1           //irqoff();
 408   1               vblock[0]= seg0_f( (n/1000) );
 409   1               n = n%1000;
 410   1               vblock[1]= seg0_f(n/100);
 411   1               n = n%100;
 412   1                              
 413   1               vblock[2]= seg0_f( (n/10) );
 414   1               vblock[3]= seg0_f( (n%10) );
 415   1               //irqon();
 416   1      }
 417                                             


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    749    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     17       2
   IDATA SIZE       =   ----    ----
C51 COMPILER V8.01   4X8SEG_VLED                                                           10/29/2009 19:45:54 PAGE 8   

   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
