C51 COMPILER V8.01   MAIN                                                                  10/07/2009 21:30:46 PAGE 1   


C51 COMPILER V8.01, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c BROWSE INCDIR(.;.\driver) DEBUG OBJECTEXTEND

line level    source

   1          #include "config.h"
   2          
   3          #include <intrins.h>
   4           
   5           /*
   6            * Timer0: 256us, display driven ticks
   7            */
   8          /*中断1， 寄存器组1 (普通函数默认用寄存器组0)*/
   9          //unsigned vblock[5]={0xFF,0xFF,0xFF,0xFF,0xFF};
  10          
  11          unsigned char vblock[5]={
  12                         segDOT,/*0*/
  13                         0XF9,/*1*/
  14                         0XA4,/*2*/
  15                         0XB0,/*3*/
  16                                     ~(0xf)};
  17          
  18          volatile unsigned  long tick=0;  //250us per ticks
  19          void timer0(void) interrupt 1 using 1   
  20          {   
  21   1      
  22   1               static unsigned char block=0;
  23   1               
  24   1               
  25   1               if(tick&0x3){ //每个持续1ms
  26   2                  tick++;
  27   2                  return;
  28   2               }
  29   1           
  30   1               if(block<4){ //scan 4x8 seg
  31   2                  vledoff(); 
  32   2                      segoff(0xF);
  33   2                      segData = vblock[block];             
  34   2                  segon(1<<block);    
  35   2               }
  36   1               else { //scan vled
  37   2                     vledon();
  38   2                         segoff(0xF);
  39   2                         segData = vblock[4];
  40   2                 
  41   2               } 
  42   1      
  43   1               block++;
  44   1               if(6==block)
  45   1                 block=0;
  46   1      
  47   1               tick++;
  48   1      }  
  49          
  50          
  51          #define timeafter(a,b)         \
  52                   (((long)(b) - (long)(a) < 0))
  53          
  54          #define rol8(a,n) \
  55                     ( \
C51 COMPILER V8.01   MAIN                                                                  10/07/2009 21:30:46 PAGE 2   

  56                               (a>>(8-(n))) | \
  57                                   (a<<(n)) \
  58                             ) 
  59          #define ror8(a,n) \
  60                     ( \
  61                               (a<<(8-(n))) | \
  62                                   (a>>(n)) \
  63                             ) 
  64          
  65          char vled_mode=1;
  66          
  67          void vledflashA()
  68          {
  69   1         vblock[4] = 0xF;
  70   1         vled_mode = 0;
  71   1      
  72   1      }
  73          
  74          void tickvled()
  75          {                    
  76   1      
  77   1              static unsigned long pos=0;
  78   1                      
  79   1                      static unsigned long lasttime=0;
  80   1      
  81   1                      
  82   1                      
  83   1                      if(! timeafter(tick,lasttime+80*4) )
  84   1                           return;
  85   1      
  86   1                      ET0 = 0;   //disable global interrupt
  87   1                      if(vled_mode  == 0) //A mA
  88   1                vblock[4]= rol8(vblock[4], 1);
  89   1                      
  90   1                      if(vled_mode == 1){ //V mV
  91   2                              if(pos&0x4 ){     // pos&0x100 == 0x100 doesn't work!!!!!!!!
  92   3                                   vblock[4] = 0x5A;
  93   3                           }else{
  94   3                                   vblock[4] = 0xA5;
  95   3                           }
  96   2                      
  97   2                      }
  98   1      
  99   1                      if(vled_mode == 2){ //Hz
 100   2                               if(pos&0x2 ){
 101   3                       vblock[4] = 0x5A;
 102   3                               }else{
 103   3                                   vblock[4] = 0xFF;
 104   3                           }
 105   2                      }     
 106   1      
 107   1               if(vled_mode == 3) { //Err
 108   2                               if(pos&0x1 ){
 109   3                                   vblock[4] = 0xFF;
 110   3                       vblock[0]=vblock[1]=vblock[2]=vblock[3]=segDOT;
 111   3                                   
 112   3                                       
 113   3                           }else{
 114   3                                   vblock[4] = 0xFF;
 115   3                       vblock[0]=vblock[1]=vblock[2]=vblock[3]=0xFF;
 116   3                                   
 117   3                                       
C51 COMPILER V8.01   MAIN                                                                  10/07/2009 21:30:46 PAGE 3   

 118   3                           }            
 119   2                       }     
 120   1                       
 121   1                      ET0 = 1;   //enable global interrupt
 122   1      
 123   1                      pos++;  
 124   1                      lasttime = tick;
 125   1               
 126   1      }
 127          
 128          void main()
 129          {
 130   1         /*power on test*/
 131   1         segoff(0xF);
 132   1         testseg();
 133   1         testvled();
 134   1      
 135   1         segoff(0xF);
 136   1         vledoff();
 137   1         /* timer0 init */
 138   1         /*  timer 0 in mode 2   */
 139   1         TMOD |= 0x2;   
 140   1         // set timer speed   
 141   1         TH0 = TL0 = 6;   
 142   1         // enable timer 0 interrupt   
 143   1         ET0 = 1;   
 144   1         
 145   1         TR0 = 1; //enable timer
 146   1      
 147   1         EA = 1;   //enable global interrupt
 148   1      
 149   1         
 150   1         vledflashA();
 151   1                      
 152   1         while(1){ 
 153   2              static unsigned long mode_show_time=0;
 154   2      
 155   2              if(timeafter(tick,mode_show_time+4*5000)){ //5s
 156   3                              
 157   3      
 158   3                                if(vled_mode == 3){
 159   4                                   vblock[4]= 0xFF;
 160   4      
 161   4                                       vblock[1]= seg0_9[(tick)>>5&0x7];
 162   4                                       vblock[2]= seg0_9[(tick)>>7&0x7];
 163   4                                       vblock[3]= seg0_9[tick&0x7];
 164   4                                       
 165   4                                       vblock[0]= segDOT;
 166   4                                } 
 167   3                                      
 168   3                                
 169   3                                vled_mode++;
 170   3                                vled_mode&=0x3;
 171   3                    
 172   3                                if(vled_mode == 0 )
 173   3                               vledflashA();                   
 174   3                                
 175   3                                mode_show_time = tick;
 176   3                                
 177   3                      }
 178   2                      tickvled();
 179   2       
C51 COMPILER V8.01   MAIN                                                                  10/07/2009 21:30:46 PAGE 4   

 180   2        
 181   2        }
 182   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    511    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     23    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
